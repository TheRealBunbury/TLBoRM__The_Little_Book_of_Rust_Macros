<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Metavariable Expressions - The Little Book of Rust Macros</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../res/rust-syntax-bg-highlight.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "ayu";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Little Book of Rust Macros</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/veykril/tlborm/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="metavariable-expressions"><a class="header" href="#metavariable-expressions">Metavariable Expressions</a></h1>
<blockquote>
<p><em>RFC</em>: <a href="https://github.com/rust-lang/rfcs/blob/master/text/3086-macro-metavar-expr.md">rfcs#1584</a><br />
<em>Tracking Issue</em>: <a href="https://github.com/rust-lang/rust/issues/83527">rust#83527</a><br />
<em>Feature</em>: <code>#![feature(macro_metavar_expr)]</code></p>
</blockquote>
<blockquote>
<p>Note: The example code snippets are very bare bones, trying to show off how they work. If you think you got small snippets with proper isolated usage of these expression please submit them!</p>
</blockquote>
<p>As mentioned in the <a href="../macros-methodical.html"><code>methodical introduction</code></a>, Rust has special expressions that can be used by macro transcribers to obtain information about metavariables that are otherwise difficult or even impossible to get.
This chapter will introduce them more in-depth together with usage examples.</p>
<ul>
<li><a href="#metavariable-expressions">Metavariable Expressions</a>
<ul>
<li><a href="#dollar-dollar-">Dollar Dollar (<code>$$</code>)</a></li>
<li><a href="#countident-depth"><code>count($ident, depth)</code></a></li>
<li><a href="#indexdepth"><code>index(depth)</code></a></li>
<li><a href="#lengthdepth"><code>len(depth)</code></a></li>
<li><a href="#ignoreident"><code>ignore($ident)</code></a></li>
</ul>
</li>
</ul>
<h2 id="dollar-dollar-"><a class="header" href="#dollar-dollar-">Dollar Dollar (<code>$$</code>)</a></h2>
<p>The <code>$$</code> expression expands to a single <code>$</code>, making it effectively an escaped <code>$</code>.
This enables the ability in writing macros emitting new macros as the former macro won't transcribe metavariables, repetitions and metavariable expressions that have an escaped <code>$</code>.</p>
<p>We can see the problem without using <code>$$</code> in the following snippet:</p>
<pre><pre class="playground"><code class="language-rust compile_fail edition2021">macro_rules! foo {
    () =&gt; {
        macro_rules! bar {
            ( $( $any:tt )* ) =&gt; { $( $any )* };
            // ^^^^^^^^^^^ error: attempted to repeat an expression containing no syntax variables matched as repeating at this depth
        }
    };
}

foo!();
<span class="boring">fn main() {}</span></code></pre></pre>
<p>The problem is obvious, the transcriber of foo sees a repetition and tries to repeat it when transcribing, but there is no <code>$any</code> metavariable in its scope causing it to fail.
With <code>$$</code> we can get around this as the transcriber of <code>foo</code> will no longer try to do the repetition.<sup class="footnote-reference" id="fr-tt-$-1"><a href="#footnote-tt-$">1</a></sup></p>
<pre><code class="language-rust ignore"><span class="boring">// This code block marked `ignore` because mdbook can't handle `#![feature(...)]`.
</span>#![feature(macro_metavar_expr)]

macro_rules! foo {
    () =&gt; {
        macro_rules! bar {
            ( $$( $$any:tt )* ) =&gt; { $$( $$any )* };
        }
    };
}

foo!();
bar!();
<span class="boring">fn main() {}</span></code></pre>
<h2 id="countident-depth"><a class="header" href="#countident-depth"><code>count($ident, depth)</code></a></h2>
<p>The <code>count</code> metavariable expression expands to the repetition count of the metavariable <code>$ident</code> up to the given repetition depth.</p>
<ul>
<li>The <code>$ident</code> argument must be a declared metavariable in the scope of the rule.</li>
<li>The <code>depth</code> argument must be an integer literal of value less or equal to the maximum repetition depth that the <code>$ident</code> metavariable appears in.</li>
<li>The expression expands to an unsuffixed integer literal token.</li>
</ul>
<p>The <code>count($ident)</code> expression defaults <code>depth</code> to the maximum valid depth, making it count the total repetitions for the given metavariable.</p>
<pre><code class="language-rust ignore"><span class="boring">// This code block marked `ignore` because mdbook can't handle `#![feature(...)]`.
</span>#![feature(macro_metavar_expr)]

macro_rules! foo {
    ( $( $outer:ident ( $( $inner:ident ),* ) ; )* ) =&gt; {
        println!("count(outer, 0): $outer repeats {} times", ${count($outer)});
        println!("count(inner, 0): The $inner repetition repeats {} times in the outer repetition", ${count($inner, 0)});
        println!("count(inner, 1): $inner repeats {} times in the inner repetitions", ${count($inner, 1)});
    };
}

fn main() {
    foo! {
        outer () ;
        outer ( inner , inner ) ;
        outer () ;
        outer ( inner ) ;
    };
}</code></pre>
<h2 id="indexdepth"><a class="header" href="#indexdepth"><code>index(depth)</code></a></h2>
<p>The <code>index(depth)</code> metavariable expression expands to the current iteration index of the repetition at the given depth.</p>
<ul>
<li>The <code>depth</code> argument targets the repetition at <code>depth</code> counting outwards from the inner-most repetition where the expression is invoked.</li>
<li>The expression expands to an unsuffixed integer literal token.</li>
</ul>
<p>The <code>index()</code> expression defaults <code>depth</code> to <code>0</code>, making it a shorthand for <code>index(0)</code>.</p>
<pre><code class="language-rust ignore"><span class="boring">// This code block marked `ignore` because mdbook can't handle `#![feature(...)]`.
</span>#![feature(macro_metavar_expr)]

macro_rules! attach_iteration_counts {
    ( $( ( $( $inner:ident ),* ) ; )* ) =&gt; {
        ( $(
            $((
                stringify!($inner),
                ${index(1)}, // this targets the outer repetition
                ${index()}  // and this, being an alias for `index(0)` targets the inner repetition
            ),)*
        )* )
    };
}

fn main() {
    let v = attach_iteration_counts! {
        ( hello ) ;
        ( indices , of ) ;
        () ;
        ( these, repetitions ) ;
    };
    println!("{v:?}");
}</code></pre>
<h2 id="lendepth"><a class="header" href="#lendepth"><code>len(depth)</code></a></h2>
<p>The <code>len(depth)</code> metavariable expression expands to the iteration count of the repetition at the given depth.</p>
<ul>
<li>The <code>depth</code> argument targets the repetition at <code>depth</code> counting outwards from the inner-most repetition where the expression is invoked.</li>
<li>The expression expands to an unsuffixed integer literal token.</li>
</ul>
<p>The <code>len()</code> expression defaults <code>depth</code> to <code>0</code>, making it a shorthand for <code>len(0)</code>.</p>
<pre><code class="language-rust ignore"><span class="boring">// This code block marked `ignore` because mdbook can't handle `#![feature(...)]`.
</span>#![feature(macro_metavar_expr)]

macro_rules! lets_count {
    ( $( $outer:ident ( $( $inner:ident ),* ) ; )* ) =&gt; {
        $(
            $(
                println!(
                    "'{}' in inner iteration {}/{} with '{}' in outer iteration {}/{} ",
                    stringify!($inner), ${index()}, ${len()},
                    stringify!($outer), ${index(1)}, ${len(1)},
                );
            )*
        )*
    };
}

fn main() {
    lets_count!(
        many (small , things) ;
        none () ;
        exactly ( one ) ;
    );
}</code></pre>
<h2 id="ignoreident"><a class="header" href="#ignoreident"><code>ignore($ident)</code></a></h2>
<p>The <code>ignore($ident)</code> metavariable expression expands to nothing, making it possible to expand something as often as a metavariable repeats without expanding the metavariable.</p>
<ul>
<li>The <code>$ident</code> argument must be a declared metavariable in the scope of the rule.</li>
</ul>
<pre><code class="language-rust ignore"><span class="boring">// This code block marked `ignore` because mdbook can't handle `#![feature(...)]`.
</span>#![feature(macro_metavar_expr)]

macro_rules! repetition_tuples {
    ( $( ( $( $inner:ident ),* ) ; )* ) =&gt; {
        ($(
            $(
                (
                    ${index()},
                    ${index(1)}
                    ${ignore($inner)} // without this metavariable expression, compilation would fail
                ),
            )*
        )*)
    };
}

fn main() {
    let tuple = repetition_tuples!(
        ( one, two ) ;
        () ;
        ( one ) ;
        ( one, two, three ) ;
    );
    println!("{tuple:?}");
}</code></pre>
<hr>
<ol class="footnote-definition"><li id="footnote-tt-$">
<p>Before <code>$$</code> was implemented, users had to resort to a tricky and not so well-known hack to declare nested macros with repetitions
<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=9ce18fc79ce17c77d20e74f3c46ee13c">via using <code>$tt</code> like this</a>. <a href="#fr-tt-$-1">↩</a></p>
</li>
</ol>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../decl-macros/minutiae/metavar-and-expansion.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../decl-macros/minutiae/hygiene.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../decl-macros/minutiae/metavar-and-expansion.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../decl-macros/minutiae/hygiene.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
